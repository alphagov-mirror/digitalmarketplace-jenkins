{% set environments = ['production'] %}
---
{% for environment in environments %}
- job:
    name: "notify-suppliers-of-intention-to-Award-(41)"
    display-name: "Notify suppliers of Intention To Award (41)"
    project-type: freestyle
    description: "Send email notifications to supplier users if they have a completed application to a brief that has been awarded."
    parameters:
      - string:
          name: NOTIFY_TEMPLATE_ID
          default: "d308ea6a-f218-4191-bb84-9e5f73d46b68"
          description: "Notify Template ID"
      - string:
          name: FRAMEWORK_SLUG
          default: null
          description: "Framework Slug e.g. 'digital-outcomes-and-specialists-5"
      - string:
          name: SUPPLIER_IDS
          default: null
          description: "Comma-separated list of Supplier IDs to be emailed (e.g. '1234,5678')"
      - bool:
          name: DRY_RUN
          default: false
          description: "List notifications that would be sent without sending the emails"
    dsl: |
      stage('Clone agreements') {
         dir('digitalmarketplace-agreements') {
           git url: 'git@github.com:alphagov/digitalmarketplace-agreements.git', branch: 'master', credentialsId: 'github_com_and_enterprise', poll: true
         }
       }
    publishers:
      - trigger-parameterized-builds:
          - project: notify-slack
            condition: UNSTABLE_OR_WORSE
            predefined-parameters: |
              USERNAME=notify-suppliers-of-intention-to-Award-(41)
              JOB=Notify suppliers of Intention To Award (41)
              ICON=:crystal_ball:
              STAGE={{ environment }}
              STATUS=FAILED
              URL=<${BUILD_URL}consoleFull|#${BUILD_NUMBER}>
              CHANNEL=#dm-2ndline
    builders:
      - shell: |
          if [ -n "$SUPPLIER_IDS" ]; then
            FLAGS="$FLAGS --brief_response_ids=$BRIEF_RESPONSE_IDS"
          fi

          if [ "$DRY_RUN" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi

          docker run --rm -e DM_DATA_API_TOKEN_{{ environment|upper }} digitalmarketplace/scripts scripts/framework-applications/notify-successful-suppliers-for-framework.py '{{ environment }}' { FRAMEWORK_SLUG } $NOTIFY_API_TOKEN { NOTIFY_TEMPLATE_ID } $FLAGS
{% endfor %}
